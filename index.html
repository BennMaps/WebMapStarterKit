<html>
    <head>
        <title>2020 Election Results - Populous Counties</title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css" crossorigin="anonymous">
        <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/pmtiles@3.0.5/dist/pmtiles.js"></script>
        <style>
            body {
                margin: 0;
            }
            #map {
                height:100%; width:100%;
            }
            .maplibregl-popup > * {
                border-radius: 6px;
                opacity: 0.75;
            }
            .maplibregl-popup-content > * {
                /* make popup content denser */
                margin: 0;
                padding: 0;
                width: 180px;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script type="text/javascript">

            let hoveredStateId = null;

            // add the PMTiles plugin to the maplibregl global.
            let pm = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles",pm.tile);

            let PMTILES_URL = "https://mizmay.github.io/WebMapStarterKit/MyData.pmtiles";
            const p = new pmtiles.PMTiles(PMTILES_URL);
            pm.add(p);

            // we first fetch the header so we can get the center lon, lat of the map.
            p.getHeader().then(h => {
                const map = new maplibregl.Map({
                    container: 'map',
                    zoom: h.minZoom+2,
                    center: [h.centerLon, h.centerLat],
                    style: {
                        version: 8,
                        sources: {
                            'MyData': {
                                type: "vector",
                                url: "pmtiles://" + PMTILES_URL,
                                attribution: 'Â© <a href="https://electionlab.mit.edu/data">MIT Election Lab</a>, <a href="https://www.naturalearthdata.com/">Natural Earth</a>',
                            }
                        },
                        layers: [
                            {
                                'id': 'counties',
                                'source': 'MyData',
                                'source-layer': 'counties',
                                'type': 'fill',
                                'paint': {
                                    'fill-color': ['get','fill_color'],
                                }
                            },
                            {
                                'id': 'states',
                                'source': 'MyData',
                                'source-layer': 'states',
                                'type': 'fill',
                                'paint': {  'fill-color': 'transparent',
                                            'fill-outline-color': 'black',
                                            'fill-opacity': [ 'case', ['==', ['get', 'swing'], 1], 1, 0]
                                        }
                            }
                        ]
                    }
                });

                map.on('click', (event) => {
                    // of all possible features under the cursor, filter to just the counties
                    let features = map.queryRenderedFeatures(event.point)
                        .filter(feature => feature.layer.id === "counties");

                    if (features.length === 0) {
                        // no counties found under cursor
                        return;
                    }

                    let feature = features[0];

                    // create a popup, set its map position and html content, and add it to the map
                    let popup = new maplibregl.Popup({ closeButton: false });
                    popup.setLngLat(event.lngLat);
                    popup.setHTML(`
                        <p>
                            <b>${feature.properties.winner}</b> won this county in 2020 with  
                            <b>${feature.properties.votes}</b> votes, <b>${feature.properties.votes_sqkm}</b> 
                            votes per square kilometer.
                        </p>
                    `);
                    popup.addTo(map);
                });
            });
        </script>
    </body>
</html>